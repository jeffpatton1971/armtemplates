{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "2019.05.01.0",
  "parameters": {
    "name": {
      "type": "string"
    },
    "Network": {
      "type": "object"
    },
    "BastionPrefix": {
      "type": "string"
    },
    "DestinationPrefix": {
      "type": "string"
    },
    "SourcePrefix": {
      "type": "string",
      "defaultValue": ""
    },
    "DeploymentType": {
      "type": "string",
      "allowedValues": [
        "ApplicationGateway",
        "Bastion",
        "DomainController",
        "SitecoreCMS",
        "SitecoreSOLR",
        "SqlServer",
        "Default"
      ],
      "defaultValue": "VirtualMachine"
    },
    "SecurityRules": {
      "type": "array",
      "defaultValue": []
    },
    "CustomObject": {
      "type": "object",
      "defaultValue": {}
    },
    "environment": {
      "type": "string",
      "allowedValues": [
        "Production",
        "Staging",
        "Test",
        "UAT",
        "Development",
        "QA",
        "DisasterRecovery",
        "Other"
      ],
      "metadata": {
        "description": "The Environment type we are building",
        "group": "Tags",
        "order": 1,
        "question": "Please enter environment type : "
      },
      "defaultValue": "Production"
    },
    "buildDate": {
      "type": "string",
      "metadata": {
        "description": "The date of this build",
        "group": "Tags",
        "order": 2,
        "question": "Please enter todays date (mm/dd/yyyy) : "
      },
      "defaultValue": "mm/dd/yyyy"
    },
    "buildBy": {
      "type": "string",
      "metadata": {
        "description": "The name of the person who build this environment",
        "group": "Tags",
        "order": 3,
        "question": "Please enter your full name : "
      },
      "defaultValue": "First Last"
    },
    "buildTicket": {
      "type": "string",
      "defaultValue": "######-#####"
    },
    "RaxAutomationExclude": {
      "type": "string",
      "allowedValues": [
        "None",
        "Monitoring",
        "Passport",
        "Antimalware"
      ],
      "metadata": {
        "description": "Select the automation type you will like to exclude for this VM",
        "group": "Tags",
        "order": 4,
        "label": "Automation Exluce",
        "question": "Choose the type of automation you will like to exclude this from"
      },
      "defaultValue": "None"
    }
  },
  "variables": {
    "rackspaceBastionDFW": "172.99.99.10/32",
    "rackspaceBastionIAD": "146.20.2.10/32",
    "rackspaceBastionORD": "161.47.0.10/32",
    "rackspaceBastionHKG": "119.9.122.10/32",
    "rackspaceBastionLON": "134.213.179.10/32",
    "rackspaceBastionLON5": "134.213.178.10/32",
    "rackspaceBastionSYD": "119.9.148.10/32",
    "rackspacepBastionDFW": "72.3.186.100/32",
    "rackspacepBastionIAD": "146.20.30.100/32",
    "rackspacepBastionORD": "161.47.6.100/32",
    "rackspacepBastionHKG": "120.136.39.100/32",
    "rackspacepBastionLON": "134.213.183.100/32",
    "rackspacepBastionLON5": "134.213.182.100/32",
    "rackspacepBastionSYD": "119.9.163.100/32",
    "RackspaceTags": {
      "Environment": "[parameters('environment')]",
      "BuildDate": "[parameters('buildDate')]",
      "BuildBy": "[parameters('buildBy')]",
      "BuildTicket": "[parameters('buildTicket')]",
      "RaxAutomation|Exclude": "[parameters('RaxAutomationExclude')]"
    },
    "tags": "[if(not(empty(parameters('CustomObject'))),union(variables('RackspaceTags'),parameters('CustomObject').tags),variables('RackspaceTags'))]",
    "defaultRules": [
      {
        "name": "[concat('Allow_LOCAL_SUBNET_INBOUND')]",
        "properties": {
          "description": "Allows intra-subnet communication",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "[parameters('DestinationPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 110,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_AZURE_LB_INBOUND')]",
        "properties": {
          "description": "Allows inbound traffic from Azure Load Balancer",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "AzureLoadBalancer",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 111,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_RDP_INBOUND')]",
        "properties": {
          "description": "Allows RDP inbound from local RBAST subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "3389",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 112,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_SSH_INBOUND')]",
        "properties": {
          "description": "Allows SSH inbound from local RBAST subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "22",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 113,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_WinRM_INBOUND')]",
        "properties": {
          "description": "Allows WinRM inbound from local RACK_BASTION subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "5986",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 114,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_SFTBROKER_INBOUND')]",
        "properties": {
          "description": "Allows ScaleFT Broker agent inbound from local RACK_BASTION subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "4421",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 115,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Deny_ALL_INBOUND_UDP')]",
        "properties": {
          "description": "Deny all inbound UDP",
          "protocol": "Udp",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "*",
          "destinationAddressPrefix": "*",
          "access": "Deny",
          "priority": 4000,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Deny_ALL_INBOUND_TCP')]",
        "properties": {
          "description": "Deny all inbound TCP",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "*",
          "destinationAddressPrefix": "*",
          "access": "Deny",
          "priority": 4001,
          "direction": "Inbound"
        }
      }
    ],
    "dcRules": [
      {
        "name": "[concat('Allow_LOCAL_SUBNET_INBOUND')]",
        "properties": {
          "description": "Allows intra-subnet communication",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "[parameters('DestinationPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 110,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_AZURE_LB_INBOUND')]",
        "properties": {
          "description": "Allows inbound traffic from Azure Load Balancer",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "AzureLoadBalancer",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 111,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_RDP_INBOUND')]",
        "properties": {
          "description": "Allows RDP inbound from local RBAST subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "3389",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 112,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_SSH_INBOUND')]",
        "properties": {
          "description": "Allows SSH inbound from local RBAST subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "22",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 113,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_WinRM_INBOUND')]",
        "properties": {
          "description": "Allows WinRM inbound from local RACK_BASTION subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "5986",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 114,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_SFTBROKER_INBOUND')]",
        "properties": {
          "description": "Allows ScaleFT Broker agent inbound from local RACK_BASTION subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "4421",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 115,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_TCP_UDP_53')]",
        "properties": {
          "description": "Allow UDP 53",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "53",
          "sourceAddressPrefix": "VirtualNetwork",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 116,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_TCP_UDP_88')]",
        "properties": {
          "description": "Allow TCP and UDP 88",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "88",
          "sourceAddressPrefix": "VirtualNetwork",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 117,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_UDP_123')]",
        "properties": {
          "description": "Allow UDP 123",
          "protocol": "Udp",
          "sourcePortRange": "*",
          "destinationPortRange": "123",
          "sourceAddressPrefix": "VirtualNetwork",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 118,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_TCP_135')]",
        "properties": {
          "description": "Allow TCP 135",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "135",
          "sourceAddressPrefix": "VirtualNetwork",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 119,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_TCP_UDP_137')]",
        "properties": {
          "description": "Allow TCP and UDP 137",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "137",
          "sourceAddressPrefix": "VirtualNetwork",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 120,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_UDP_138')]",
        "properties": {
          "description": "Allow UDP 138",
          "protocol": "Udp",
          "sourcePortRange": "*",
          "destinationPortRange": "138",
          "sourceAddressPrefix": "VirtualNetwork",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 121,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_TCP_139')]",
        "properties": {
          "description": "Allow TCP 139",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "139",
          "sourceAddressPrefix": "VirtualNetwork",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 122,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_TCP_UDP_389')]",
        "properties": {
          "description": "Allow TCP and UDP 389",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "389",
          "sourceAddressPrefix": "VirtualNetwork",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 123,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_TCP_UDP_445')]",
        "properties": {
          "description": "Allow TCP and UDP 445",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "445",
          "sourceAddressPrefix": "VirtualNetwork",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 124,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_TCP_UDP_464')]",
        "properties": {
          "description": "Allow TCP and UDP 464",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "464",
          "sourceAddressPrefix": "VirtualNetwork",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 125,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_TCP_636')]",
        "properties": {
          "description": "Allow TCP 636",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "636",
          "sourceAddressPrefix": "VirtualNetwork",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 126,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_TCP_3268')]",
        "properties": {
          "description": "Allow TCP 3268",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "3268",
          "sourceAddressPrefix": "VirtualNetwork",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 127,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_TCP_3269')]",
        "properties": {
          "description": "Allow TCP 3269",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "3269",
          "sourceAddressPrefix": "VirtualNetwork",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 128,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_TCP_5722')]",
        "properties": {
          "description": "Allow TCP 5722",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "5722",
          "sourceAddressPrefix": "VirtualNetwork",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 129,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_TCP_UDP_49152_65535')]",
        "properties": {
          "description": "Allow TCP and UDP 49152_65535",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "49152-65535",
          "sourceAddressPrefix": "VirtualNetwork",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 130,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_TCP_9389')]",
        "properties": {
          "description": "Allow TCP 9389",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "9389",
          "sourceAddressPrefix": "VirtualNetwork",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 131,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_WinRM_5985')]",
        "properties": {
          "description": "Allow WinRM 5985",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "5985",
          "sourceAddressPrefix": "VirtualNetwork",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 132,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Deny_ALL_INBOUND_UDP')]",
        "properties": {
          "description": "Deny all inbound UDP",
          "protocol": "Udp",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "*",
          "destinationAddressPrefix": "*",
          "access": "Deny",
          "priority": 4000,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Deny_ALL_INBOUND_TCP')]",
        "properties": {
          "description": "Deny all inbound TCP",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "*",
          "destinationAddressPrefix": "*",
          "access": "Deny",
          "priority": 4001,
          "direction": "Inbound"
        }
      }
    ],
    "agwRules": [
      {
        "name": "[concat('Allow_LOCAL_SUBNET_INBOUND')]",
        "properties": {
          "description": "Allows intra-subnet communication",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "[parameters('DestinationPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 110,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_AZURE_LB_INBOUND')]",
        "properties": {
          "description": "Allows inbound traffic from Azure Load Balancer",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "AzureLoadBalancer",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 111,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_RDP_INBOUND')]",
        "properties": {
          "description": "Allows RDP inbound from local RBAST subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "3389",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 112,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_SSH_INBOUND')]",
        "properties": {
          "description": "Allows SSH inbound from local RBAST subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "22",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 113,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_WinRM_INBOUND')]",
        "properties": {
          "description": "Allows WinRM inbound from local RACK_BASTION subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "5986",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 114,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_SFTBROKER_INBOUND')]",
        "properties": {
          "description": "Allows ScaleFT Broker agent inbound from local RACK_BASTION subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "4421",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 115,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_Internet_Inbound_HTTP')]",
        "properties": {
          "description": "Allows inbound http to the Application Gateway subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "80",
          "sourceAddressPrefix": "*",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 133,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_Internet_Inbound_HTTPS')]",
        "properties": {
          "description": "Allows inbound https to the Application Gateway subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "443",
          "sourceAddressPrefix": "*",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 134,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_TCP_UDP_65200_65535')]",
        "properties": {
          "description": "Allow TCP and UDP 65200_65535",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "65200-65535",
          "sourceAddressPrefix": "VirtualNetwork",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 135,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Deny_ALL_INBOUND_UDP')]",
        "properties": {
          "description": "Deny all inbound UDP",
          "protocol": "Udp",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "*",
          "destinationAddressPrefix": "*",
          "access": "Deny",
          "priority": 4000,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Deny_ALL_INBOUND_TCP')]",
        "properties": {
          "description": "Deny all inbound TCP",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "*",
          "destinationAddressPrefix": "*",
          "access": "Deny",
          "priority": 4001,
          "direction": "Inbound"
        }
      }
    ],
    "cmsRules": [
      {
        "name": "[concat('Allow_LOCAL_SUBNET_INBOUND')]",
        "properties": {
          "description": "Allows intra-subnet communication",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "[parameters('DestinationPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 110,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_AZURE_LB_INBOUND')]",
        "properties": {
          "description": "Allows inbound traffic from Azure Load Balancer",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "AzureLoadBalancer",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 111,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_RDP_INBOUND')]",
        "properties": {
          "description": "Allows RDP inbound from local RBAST subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "3389",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 112,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_SSH_INBOUND')]",
        "properties": {
          "description": "Allows SSH inbound from local RBAST subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "22",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 113,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_WinRM_INBOUND')]",
        "properties": {
          "description": "Allows WinRM inbound from local RACK_BASTION subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "5986",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 114,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_SFTBROKER_INBOUND')]",
        "properties": {
          "description": "Allows ScaleFT Broker agent inbound from local RACK_BASTION subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "4421",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 115,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_SITECORE_80_INBOUND')]",
        "properties": {
          "description": "Allow inbound sitecore endpoint access",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "80",
          "sourceAddressPrefix": "VirtualNetwork",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 136,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_SITECORE_443_INBOUND')]",
        "properties": {
          "description": "Allow inbound sitecore endpoint access",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "443",
          "sourceAddressPrefix": "VirtualNetwork",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 137,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Deny_ALL_INBOUND_UDP')]",
        "properties": {
          "description": "Deny all inbound UDP",
          "protocol": "Udp",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "*",
          "destinationAddressPrefix": "*",
          "access": "Deny",
          "priority": 4000,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Deny_ALL_INBOUND_TCP')]",
        "properties": {
          "description": "Deny all inbound TCP",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "*",
          "destinationAddressPrefix": "*",
          "access": "Deny",
          "priority": 4001,
          "direction": "Inbound"
        }
      }
    ],
    "solrRules": [
      {
        "name": "[concat('Allow_LOCAL_SUBNET_INBOUND')]",
        "properties": {
          "description": "Allows intra-subnet communication",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "[parameters('DestinationPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 110,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_AZURE_LB_INBOUND')]",
        "properties": {
          "description": "Allows inbound traffic from Azure Load Balancer",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "AzureLoadBalancer",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 111,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_RDP_INBOUND')]",
        "properties": {
          "description": "Allows RDP inbound from local RBAST subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "3389",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 112,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_SSH_INBOUND')]",
        "properties": {
          "description": "Allows SSH inbound from local RBAST subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "22",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 113,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_WinRM_INBOUND')]",
        "properties": {
          "description": "Allows WinRM inbound from local RACK_BASTION subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "5986",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 114,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_SFTBROKER_INBOUND')]",
        "properties": {
          "description": "Allows ScaleFT Broker agent inbound from local RACK_BASTION subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "4421",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 115,
          "direction": "Inbound"
        }
      },     
      {
        "name": "[concat('Allow_SITECORE_80_INBOUND')]",
        "properties": {
          "description": "Allow inbound sitecore endpoint access",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "80",
          "sourceAddressPrefix": "VirtualNetwork",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 138,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_SITECORE_443_INBOUND')]",
        "properties": {
          "description": "Allow inbound sitecore endpoint access",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "443",
          "sourceAddressPrefix": "VirtualNetwork",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 139,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_SOLR_8984_INBOUND')]",
        "properties": {
          "description": "Allow inbound solr endpoint access",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "8984",
          "sourceAddressPrefix": "VirtualNetwork",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 140,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Deny_ALL_INBOUND_UDP')]",
        "properties": {
          "description": "Deny all inbound UDP",
          "protocol": "Udp",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "*",
          "destinationAddressPrefix": "*",
          "access": "Deny",
          "priority": 4000,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Deny_ALL_INBOUND_TCP')]",
        "properties": {
          "description": "Deny all inbound TCP",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "*",
          "destinationAddressPrefix": "*",
          "access": "Deny",
          "priority": 4001,
          "direction": "Inbound"
        }
      }
    ],
    "sqlRules": [
      {
        "name": "[concat('Allow_LOCAL_SUBNET_INBOUND')]",
        "properties": {
          "description": "Allows intra-subnet communication",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "[parameters('DestinationPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 110,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_AZURE_LB_INBOUND')]",
        "properties": {
          "description": "Allows inbound traffic from Azure Load Balancer",
          "protocol": "*",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "AzureLoadBalancer",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 111,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_RDP_INBOUND')]",
        "properties": {
          "description": "Allows RDP inbound from local RBAST subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "3389",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 112,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_SSH_INBOUND')]",
        "properties": {
          "description": "Allows SSH inbound from local RBAST subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "22",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 113,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_WinRM_INBOUND')]",
        "properties": {
          "description": "Allows WinRM inbound from local RACK_BASTION subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "5986",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 114,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RACK_BASTION_SFTBROKER_INBOUND')]",
        "properties": {
          "description": "Allows ScaleFT Broker agent inbound from local RACK_BASTION subnet",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "4421",
          "sourceAddressPrefix": "[parameters('BastionPrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 115,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_',replace(replace(parameters('SourcePrefix'),'/','-'),'.','_'),'_TCP_1433_INBOUND')]",
        "properties": {
          "description": "Allows TCP 1433 Inbound",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "1433",
          "sourceAddressPrefix": "[parameters('SourcePrefix')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 141,
          "direction": "Inbound"
        }
      },      {
        "name": "[concat('Deny_ALL_INBOUND_UDP')]",
        "properties": {
          "description": "Deny all inbound UDP",
          "protocol": "Udp",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "*",
          "destinationAddressPrefix": "*",
          "access": "Deny",
          "priority": 4000,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Deny_ALL_INBOUND_TCP')]",
        "properties": {
          "description": "Deny all inbound TCP",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "*",
          "sourceAddressPrefix": "*",
          "destinationAddressPrefix": "*",
          "access": "Deny",
          "priority": 4001,
          "direction": "Inbound"
        }
      }
    ],
    "rbastRules": [
      {
        "name": "[concat('Allow_RAX_SSH_DFW')]",
        "properties": {
          "description": "Allows SSH",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "22",
          "sourceAddressPrefix": "[variables('rackspaceBastionDFW')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 142,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SSH_IAD')]",
        "properties": {
          "description": "Allows SSH",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "22",
          "sourceAddressPrefix": "[variables('rackspaceBastionIAD')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 143,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SSH_ORD')]",
        "properties": {
          "description": "Allows SSH",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "22",
          "sourceAddressPrefix": "[variables('rackspaceBastionORD')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 144,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SSH_HKG')]",
        "properties": {
          "description": "Allows SSH",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "22",
          "sourceAddressPrefix": "[variables('rackspaceBastionHKG')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 145,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SSH_LON')]",
        "properties": {
          "description": "Allows SSH",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "22",
          "sourceAddressPrefix": "[variables('rackspaceBastionLON')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 146,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SSH_LON5')]",
        "properties": {
          "description": "Allows SSH",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "22",
          "sourceAddressPrefix": "[variables('rackspaceBastionLON5')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 147,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SSH_SYD')]",
        "properties": {
          "description": "Allows SSH",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "22",
          "sourceAddressPrefix": "[variables('rackspaceBastionSYD')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 148,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SSH_PDFW')]",
        "properties": {
          "description": "Allows SSH",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "22",
          "sourceAddressPrefix": "[variables('rackspacepBastionDFW')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 149,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SSH_PIAD')]",
        "properties": {
          "description": "Allows SSH",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "22",
          "sourceAddressPrefix": "[variables('rackspacepBastionIAD')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 150,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SSH_PORD')]",
        "properties": {
          "description": "Allows SSH",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "22",
          "sourceAddressPrefix": "[variables('rackspacepBastionORD')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 151,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SSH_PHKG')]",
        "properties": {
          "description": "Allows SSH",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "22",
          "sourceAddressPrefix": "[variables('rackspacepBastionHKG')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 152,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SSH_PLON')]",
        "properties": {
          "description": "Allows SSH",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "22",
          "sourceAddressPrefix": "[variables('rackspacepBastionLON')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 153,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SSH_PLON5')]",
        "properties": {
          "description": "Allows SSH",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "22",
          "sourceAddressPrefix": "[variables('rackspacepBastionLON5')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 154,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SSH_PSYD')]",
        "properties": {
          "description": "Allows SSH",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "22",
          "sourceAddressPrefix": "[variables('rackspacepBastionSYD')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 155,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SFT_DFW')]",
        "properties": {
          "description": "Allows SFT",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "4421",
          "sourceAddressPrefix": "[variables('rackspaceBastionDFW')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 156,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SFT_IAD')]",
        "properties": {
          "description": "Allows SFT",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "4421",
          "sourceAddressPrefix": "[variables('rackspaceBastionIAD')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 157,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SFT_ORD')]",
        "properties": {
          "description": "Allows SFT",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "4421",
          "sourceAddressPrefix": "[variables('rackspaceBastionORD')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 158,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SFT_HKG')]",
        "properties": {
          "description": "Allows SFT",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "4421",
          "sourceAddressPrefix": "[variables('rackspaceBastionHKG')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 159,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SFT_LON')]",
        "properties": {
          "description": "Allows SFT",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "4421",
          "sourceAddressPrefix": "[variables('rackspaceBastionLON')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 160,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SFT_LON5')]",
        "properties": {
          "description": "Allows SFT",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "4421",
          "sourceAddressPrefix": "[variables('rackspaceBastionLON5')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 161,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SFT_SYD')]",
        "properties": {
          "description": "Allows SFT",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "4421",
          "sourceAddressPrefix": "[variables('rackspaceBastionSYD')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 162,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SFT_PDFW')]",
        "properties": {
          "description": "Allows SFT",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "4421",
          "sourceAddressPrefix": "[variables('rackspacepBastionDFW')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 163,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SFT_PIAD')]",
        "properties": {
          "description": "Allows SFT",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "4421",
          "sourceAddressPrefix": "[variables('rackspacepBastionIAD')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 164,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SFT_PORD')]",
        "properties": {
          "description": "Allows SFT",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "4421",
          "sourceAddressPrefix": "[variables('rackspacepBastionORD')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 165,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SFT_PHKG')]",
        "properties": {
          "description": "Allows SFT",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "4421",
          "sourceAddressPrefix": "[variables('rackspacepBastionHKG')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 166,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SFT_PLON')]",
        "properties": {
          "description": "Allows SFT",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "4421",
          "sourceAddressPrefix": "[variables('rackspacepBastionLON')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 167,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SFT_PLON5')]",
        "properties": {
          "description": "Allows SFT",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "4421",
          "sourceAddressPrefix": "[variables('rackspacepBastionLON5')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 168,
          "direction": "Inbound"
        }
      },
      {
        "name": "[concat('Allow_RAX_SFT_PSYD')]",
        "properties": {
          "description": "Allows SFT",
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "4421",
          "sourceAddressPrefix": "[variables('rackspacepBastionSYD')]",
          "destinationAddressPrefix": "[parameters('DestinationPrefix')]",
          "access": "Allow",
          "priority": 169,
          "direction": "Inbound"
        }
      }
    ],
    "SecurityRules": {
      "ApplicationGateway": "[if(not(empty(parameters('SecurityRules'))),concat(parameters('SecurityRules'),variables('agwRules')),variables('agwRules'))]",
      "Bastion": "[if(not(empty(parameters('SecurityRules'))),concat(parameters('SecurityRules'),variables('rbastRules')),variables('rbastRules'))]",
      "DomainController": "[if(not(empty(parameters('SecurityRules'))),concat(parameters('SecurityRules'),variables('dcRules')),variables('dcRules'))]",
      "SitecoreCMS": "[if(not(empty(parameters('SecurityRules'))),concat(parameters('SecurityRules'),variables('cmsRules')),variables('cmsRules'))]",
      "SitecoreSOLR": "[if(not(empty(parameters('SecurityRules'))),concat(parameters('SecurityRules'),variables('solrRules')),variables('solrRules'))]",
      "SqlServer": "[if(not(empty(parameters('SecurityRules'))),concat(parameters('SecurityRules'),variables('sqlRules')),variables('sqlRules'))]",
      "Default": "[if(not(empty(parameters('SecurityRules'))),concat(parameters('SecurityRules'),variables('defaultRules')),variables('defaultRules'))]"
    },
    "subnet": {
      "apiVersion": "2018-04-01",
      "type": "Microsoft.Network/virtualNetworks/subnets",
      "name": "[concat(parameters('Network').VirtualNetworkName,'/',parameters('Network').SubnetName)]",
      "location": "[resourceGroup().location]",
      "dependsOn": [],
      "properties": {
        "addressPrefix": "[parameters('DestinationPrefix')]",
        "networkSecurityGroup": {
          "id": "[resourceId('Microsoft.Network/networkSecurityGroups',parameters('name'))]"
        }
      }
    },
    "networkSecurityGroup": {
      "apiVersion": "2018-08-01",
      "type": "Microsoft.Network/networkSecurityGroups",
      "name": "[parameters('name')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [ "[concat('Microsoft.Network/virtualNetworks/',parameters('Network').VirtualNetworkName,'/subnets/',parameters('Network').SubnetName)]" ],
      "properties": {
        "securityRules": "[variables('SecurityRules')[parameters('DeploymentType')]]"
      },
      "tags": "[variables('tags')]"
    },
    "resourceId": "[concat('/subscriptions/',subscription().id,'/','/resourceGroups/',resourceGroup().name,'/providers/Microsoft.Network/networkSecurityGroups/',parameters('name'))]"
  },
  "resources": [
    {
      "apiVersion": "2018-04-01",
      "type": "Microsoft.Network/virtualNetworks/subnets",
      "name": "[concat(parameters('Network').VirtualNetworkName,'/',parameters('Network').SubnetName)]",
      "location": "[resourceGroup().location]",
      "dependsOn": [ "[concat('Microsoft.Network/networkSecurityGroups/',parameters('name'))]" ],
      "properties": {
        "addressPrefix": "[parameters('DestinationPrefix')]",
        "networkSecurityGroup": {
          "id": "[resourceId('Microsoft.Network/networkSecurityGroups',parameters('name'))]"
        }
      }
    },
    {
      "apiVersion": "2018-08-01",
      "type": "Microsoft.Network/networkSecurityGroups",
      "name": "[parameters('name')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [  ],
      "properties": {
        "securityRules": "[variables('SecurityRules')[parameters('DeploymentType')]]"
      },
      "tags": "[variables('tags')]"
    }
  ],
  "outputs": {
    "armTemplate": {
      "type": "object",
      "value": {
        "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
        "contentVersion": "2019.05.01.0",
        "parameters": {},
        "variables": {},
        "resources": "[createArray(variables('subnet'),variables('networkSecurityGroup'))]",
        "outputs": {}
      }
    }
  }
}