{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "2018.12.01.0",
  "parameters": {
    "VirtualNetworkResourceGroupName": {
      "type": "string"
    },
    "VirtualNetworkName": {
      "type": "string"
    },
    "SubnetName": {
      "type": "string"
    },
    "SubnetPrefix": {
      "type": "string"
    },
    "BastionPrefix": {
      "type": "string"
    },
    "DeploymentType": {
      "type": "string",
      "allowedValues": [
        "ApplicationGateway",
        "Bastion",
        "DomainController",
        "VirtualMachine"
      ],
      "defaultValue": "VirtualMachine"
    },
    "environment": {
      "type": "string",
      "allowedValues": [
        "Production",
        "Staging",
        "Test",
        "UAT",
        "Development",
        "Disaster Recovery",
        "Q/A",
        "Other"
      ],
      "metadata": {
        "description": "The Environment type we are building",
        "group": "Tags",
        "order": 1,
        "question": "Please enter environment type : "
      },
      "defaultValue": "Production"
    },
    "buildDate": {
      "type": "string",
      "metadata": {
        "description": "The date of this build",
        "group": "Tags",
        "order": 2,
        "question": "Please enter todays date (mm/dd/yyyy) : "
      },
      "defaultValue": "mm/dd/yyyy"
    },
    "buildBy": {
      "type": "string",
      "metadata": {
        "description": "The name of the person who build this environment",
        "group": "Tags",
        "order": 3,
        "question": "Please enter your full name : "
      },
      "defaultValue": "First Last"
    },
    "RaxAutomationExclude": {
      "type": "string",
      "allowedValues": [
        "None",
        "Monitoring",
        "Passport",
        "Antimalware"
      ],
      "metadata": {
        "description": "Select the automation type you will like to exclude for this VM",
        "group": "Tags",
        "order": 4,
        "label": "Automation Exluce",
        "question": "Choose the type of automation you will like to exclude this from"
      },
      "defaultValue": "None"
    }
  },
  "variables": {
    "rackspaceBastionDFW": "172.99.99.10/32",
    "rackspaceBastionIAD": "146.20.2.10/32",
    "rackspaceBastionORD": "161.47.0.10/32",
    "rackspaceBastionHKG": "119.9.122.10/32",
    "rackspaceBastionLON": "134.213.179.10/32",
    "rackspaceBastionLON5": "134.213.178.10/32",
    "rackspaceBastionSYD": "119.9.148.10/32",
    "rackspacepBastionDFW": "72.3.186.100/32",
    "rackspacepBastionIAD": "146.20.30.100/32",
    "rackspacepBastionORD": "161.47.6.100/32",
    "rackspacepBastionHKG": "120.136.39.100/32",
    "rackspacepBastionLON": "134.213.183.100/32",
    "rackspacepBastionLON5": "134.213.182.100/32",
    "rackspacepBastionSYD": "119.9.163.100/32",
    "name": "[concat(parameters('SubnetName'),'-nsg')]",
    "tags": {
      "Environment": "[parameters('environment')]",
      "BuildDate": "[parameters('buildDate')]",
      "BuildBy": "[parameters('buildBy')]",
      "RaxAutomation|Exclude": "[parameters('RaxAutomationExclude')]"
    }
  },
  "resources": [
    {
      "apiVersion": "2018-04-01",
      "type": "Microsoft.Network/virtualNetworks/subnets",
      "name": "[concat(parameters('VirtualNetworkName'),'/',parameters('SubnetName'))]",
      "location": "[resourceGroup().location]",
      "dependsOn": [],
      "properties": {
        "addressPrefix": "[parameters('SubnetPrefix')]",
        "networkSecurityGroup": {
          "id": "[resourceId('Microsoft.Network/networkSecurityGroups',variables('name'))]"
        }
      }
    },
    {
      "apiVersion": "2015-05-01-preview",
      "type": "Microsoft.Network/networkSecurityGroups",
      "name": "[variables('name')]",
      "dependsOn": [
      ],
      "location": "[resourceGroup().location]",
      "tags": "[variables('tags')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2017-05-10",
      "resourceGroup": "[parameters('VirtualNetworkResourceGroupName')]",
      "name": "VirtualMachine-SecurityRules",
      "condition": "[equals(parameters('DeploymentType'),'VirtualMachine')]",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
          "contentVersion": "2018.11.01.0",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_LOCAL_SUBNET_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows intra-subnet communication",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "sourceAddressPrefix": "[parameters('SubnetPrefix')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 110,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_AZURE_LB_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows inbound traffic from Azure Load Balancer",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "sourceAddressPrefix": "AzureLoadBalancer",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 111,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RACK_BASTION_RDP_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows RDP inbound from local RBAST subnet",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "[parameters('BastionPrefix')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 112,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RACK_BASTION_SSH_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows SSH inbound from local RBAST subnet",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "22",
                "sourceAddressPrefix": "[parameters('BastionPrefix')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 113,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RACK_BASTION_WinRM_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows WinRM inbound from local RACK_BASTION subnet",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "5986",
                "sourceAddressPrefix": "[parameters('BastionPrefix')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 114,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RACK_BASTION_SFTBROKER_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows ScaleFT Broker agent inbound from local RACK_BASTION subnet",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "4421",
                "sourceAddressPrefix": "[parameters('BastionPrefix')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 115,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Deny_ALL_INBOUND_UDP')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Deny all inbound UDP",
                "protocol": "Udp",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Deny",
                "priority": 4000,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Deny_ALL_INBOUND_TCP')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Deny all inbound TCP",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Deny",
                "priority": 4001,
                "direction": "Inbound"
              }
            }
          ],
          "outputs": {}
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2017-05-10",
      "resourceGroup": "[parameters('VirtualNetworkResourceGroupName')]",
      "name": "DomainController-SecurityRules",
      "condition": "[equals(parameters('DeploymentType'),'DomainController')]",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
          "contentVersion": "2018.11.01.0",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_LOCAL_SUBNET_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows intra-subnet communication",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "sourceAddressPrefix": "[parameters('SubnetPrefix')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 110,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_AZURE_LB_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows inbound traffic from Azure Load Balancer",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "sourceAddressPrefix": "AzureLoadBalancer",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 111,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RACK_BASTION_RDP_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows RDP inbound from local RBAST subnet",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "[parameters('BastionPrefix')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 112,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RACK_BASTION_SSH_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows SSH inbound from local RBAST subnet",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "22",
                "sourceAddressPrefix": "[parameters('BastionPrefix')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 113,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RACK_BASTION_WinRM_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows WinRM inbound from local RACK_BASTION subnet",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "5986",
                "sourceAddressPrefix": "[parameters('BastionPrefix')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 114,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RACK_BASTION_SFTBROKER_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows ScaleFT Broker agent inbound from local RACK_BASTION subnet",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "4421",
                "sourceAddressPrefix": "[parameters('BastionPrefix')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 115,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_TCP_UDP_53')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allow UDP 53",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "53",
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 116,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_TCP_UDP_88')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allow TCP and UDP 88",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "88",
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 117,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_UDP_123')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allow UDP 123",
                "protocol": "Udp",
                "sourcePortRange": "*",
                "destinationPortRange": "123",
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 118,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_TCP_135')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allow TCP 135",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "135",
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 119,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_TCP_UDP_137')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allow TCP and UDP 137",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "137",
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 120,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_UDP_138')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allow UDP 138",
                "protocol": "Udp",
                "sourcePortRange": "*",
                "destinationPortRange": "138",
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 121,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_TCP_139')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allow TCP 139",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "139",
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 122,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_TCP_UDP_389')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allow TCP and UDP 389",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "389",
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 123,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_TCP_UDP_445')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allow TCP and UDP 445",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "445",
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 124,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_TCP_UDP_464')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allow TCP and UDP 464",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "464",
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 125,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_TCP_636')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allow TCP 636",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "636",
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 126,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_TCP_3268')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allow TCP 3268",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "3268",
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 127,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_TCP_3269')]",
              "location": "[resourceGroup().location]",

              "properties": {
                "description": "Allow TCP 3269",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "3269",
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 128,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_TCP_5722')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allow TCP 5722",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "5722",
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 129,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_TCP_UDP_49152_65535')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allow TCP and UDP 49152_65535",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "49152-65535",
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 130,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_TCP_9389')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allow TCP 9389",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "9389",
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 131,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_WinRM_5985')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allow WinRM 5985",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "5985",
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 132,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Deny_ALL_INBOUND_UDP')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Deny all inbound UDP",
                "protocol": "Udp",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Deny",
                "priority": 4000,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Deny_ALL_INBOUND_TCP')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Deny all inbound TCP",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Deny",
                "priority": 4001,
                "direction": "Inbound"
              }
            }
          ],
          "outputs": {}
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2017-05-10",
      "resourceGroup": "[parameters('VirtualNetworkResourceGroupName')]",
      "name": "Bastion-SecurityRules",
      "condition": "[equals(parameters('DeploymentType'),'Bastion')]",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
          "contentVersion": "2018.11.01.0",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_LOCAL_SUBNET_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows intra-subnet communication",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "sourceAddressPrefix": "[parameters('SubnetPrefix')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 110,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_AZURE_LB_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows inbound traffic from Azure Load Balancer",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "sourceAddressPrefix": "AzureLoadBalancer",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 111,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RACK_BASTION_RDP_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows RDP inbound from local RBAST subnet",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "[parameters('BastionPrefix')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 112,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RACK_BASTION_SSH_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows SSH inbound from local RBAST subnet",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "22",
                "sourceAddressPrefix": "[parameters('BastionPrefix')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 113,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RACK_BASTION_WinRM_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows WinRM inbound from local RACK_BASTION subnet",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "5986",
                "sourceAddressPrefix": "[parameters('BastionPrefix')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 114,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RACK_BASTION_SFTBROKER_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows ScaleFT Broker agent inbound from local RACK_BASTION subnet",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "4421",
                "sourceAddressPrefix": "[parameters('BastionPrefix')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 115,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_RDP_DFW')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows RDP",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "[variables('rackspaceBastionDFW')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 144,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_RDP_IAD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows RDP",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "[variables('rackspaceBastionIAD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 145,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_RDP_ORD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows RDP",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "[variables('rackspaceBastionORD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 146,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_RDP_HKG')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows RDP",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "[variables('rackspaceBastionHKG')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 147,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_RDP_LON')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows RDP",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "[variables('rackspaceBastionLON')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 148,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_RDP_LON5')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows RDP",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "[variables('rackspaceBastionLON5')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 149,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_RDP_SYD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows RDP",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "[variables('rackspaceBastionSYD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 150,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_SSH_DFW')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows SSH",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "22",
                "sourceAddressPrefix": "[variables('rackspaceBastionDFW')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 151,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_SSH_IAD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows SSH",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "22",
                "sourceAddressPrefix": "[variables('rackspaceBastionIAD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 152,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_SSH_ORD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows SSH",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "22",
                "sourceAddressPrefix": "[variables('rackspaceBastionORD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 153,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_SSH_HKG')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows SSH",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "22",
                "sourceAddressPrefix": "[variables('rackspaceBastionHKG')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 154,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_SSH_LON')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows SSH",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "22",
                "sourceAddressPrefix": "[variables('rackspaceBastionLON')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 155,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_SSH_LON5')]",
              "location": "[resourceGroup().location]",

              "properties": {
                "description": "Allows SSH",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "22",
                "sourceAddressPrefix": "[variables('rackspaceBastionLON5')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 156,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_SSH_SYD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows SSH",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "22",
                "sourceAddressPrefix": "[variables('rackspaceBastionSYD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 157,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_HTTPS_DFW')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows HTTPS",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "sourceAddressPrefix": "[variables('rackspaceBastionDFW')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 158,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_HTTPS_IAD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows HTTPS",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "sourceAddressPrefix": "[variables('rackspaceBastionIAD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 159,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_HTTPS_ORD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows HTTPS",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "sourceAddressPrefix": "[variables('rackspaceBastionORD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 160,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_HTTPS_HKG')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows HTTPS",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "sourceAddressPrefix": "[variables('rackspaceBastionHKG')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 167,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_HTTPS_LON')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows HTTPS",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "sourceAddressPrefix": "[variables('rackspaceBastionLON')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 168,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_HTTPS_LON5')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows HTTPS",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "sourceAddressPrefix": "[variables('rackspaceBastionLON5')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 169,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_HTTPS_SYD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows HTTPS",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "sourceAddressPrefix": "[variables('rackspaceBastionSYD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 170,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_WinRM_LON')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows WinRM",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "5986",
                "sourceAddressPrefix": "[variables('rackspaceBastionLON')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 171,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_WinRM_LON5')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows WinRM",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "5986",
                "sourceAddressPrefix": "[variables('rackspaceBastionLON5')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 172,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_WinRM_DFW')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows WinRM",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "5986",
                "sourceAddressPrefix": "[variables('rackspaceBastionDFW')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 173,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_WinRM_ORD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows WinRM",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "5986",
                "sourceAddressPrefix": "[variables('rackspaceBastionORD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 174,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_WinRM_IAD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows WinRM",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "5986",
                "sourceAddressPrefix": "[variables('rackspaceBastionIAD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 175,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_WinRM_HKG')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows WinRM",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "5986",
                "sourceAddressPrefix": "[variables('rackspaceBastionHKG')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 176,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_WinRM_SYD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows WinRM",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "5986",
                "sourceAddressPrefix": "[variables('rackspaceBastionSYD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 177,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_RDP_PDFW')]",
              "location": "[resourceGroup().location]",

              "properties": {
                "description": "Allows RDP",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "[variables('rackspacepBastionDFW')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 178,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_SSH_PDFW')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows SSH",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "22",
                "sourceAddressPrefix": "[variables('rackspacepBastionDFW')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 179,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_HTTPS_PDFW')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows HTTPS",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "sourceAddressPrefix": "[variables('rackspacepBastionDFW')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 180,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_WinRM_PDFW')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows WinRM",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "5986",
                "sourceAddressPrefix": "[variables('rackspacepBastionDFW')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 181,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_RDP_PIAD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows RDP",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "[variables('rackspacepBastionIAD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 182,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_SSH_PIAD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows SSH",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "22",
                "sourceAddressPrefix": "[variables('rackspacepBastionIAD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 183,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_HTTPS_PIAD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows HTTPS",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "sourceAddressPrefix": "[variables('rackspacepBastionIAD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 184,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_WinRM_PIAD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows WinRM",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "5986",
                "sourceAddressPrefix": "[variables('rackspacepBastionIAD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 185,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_RDP_PORD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows RDP",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "[variables('rackspacepBastionORD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 186,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_SSH_PORD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows SSH",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "22",
                "sourceAddressPrefix": "[variables('rackspacepBastionORD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 187,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_HTTPS_PORD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows HTTPS",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "sourceAddressPrefix": "[variables('rackspacepBastionORD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 188,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_WinRM_PORD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows WinRM",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "5986",
                "sourceAddressPrefix": "[variables('rackspacepBastionORD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 189,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_RDP_PHKG')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows RDP",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "[variables('rackspacepBastionHKG')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 190,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_SSH_PHKG')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows SSH",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "22",
                "sourceAddressPrefix": "[variables('rackspacepBastionHKG')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 191,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_HTTPS_PHKG')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows HTTPS",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "sourceAddressPrefix": "[variables('rackspacepBastionHKG')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 192,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_WinRM_PHKG')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows WinRM",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "5986",
                "sourceAddressPrefix": "[variables('rackspacepBastionHKG')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 193,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_RDP_PLON')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows RDP",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "[variables('rackspacepBastionLON')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 194,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_SSH_PLON')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows SSH",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "22",
                "sourceAddressPrefix": "[variables('rackspacepBastionLON')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 195,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_HTTPS_PLON')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows HTTPS",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "sourceAddressPrefix": "[variables('rackspacepBastionLON')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 196,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_WinRM_PLON')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows WinRM",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "5986",
                "sourceAddressPrefix": "[variables('rackspacepBastionLON')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 197,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_RDP_PLON5')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows RDP",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "[variables('rackspacepBastionLON5')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 198,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_SSH_PLON5')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows SSH",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "22",
                "sourceAddressPrefix": "[variables('rackspacepBastionLON5')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 199,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_HTTPS_PLON5')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows HTTPS",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "sourceAddressPrefix": "[variables('rackspacepBastionLON5')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 200,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_WinRM_PLON5')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows WinRM",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "5986",
                "sourceAddressPrefix": "[variables('rackspacepBastionLON5')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 201,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_RDP_PSYD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows RDP",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "[variables('rackspacepBastionSYD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 202,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_SSH_PSYD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows SSH",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "22",
                "sourceAddressPrefix": "[variables('rackspacepBastionSYD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 203,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_HTTPS_PSYD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows HTTPS",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "sourceAddressPrefix": "[variables('rackspacepBastionSYD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 204,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RAX_WinRM_PSYD')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows WinRM",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "5986",
                "sourceAddressPrefix": "[variables('rackspacepBastionSYD')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 205,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Deny_ALL_INBOUND_UDP')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Deny all inbound UDP",
                "protocol": "Udp",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Deny",
                "priority": 4000,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Deny_ALL_INBOUND_TCP')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Deny all inbound TCP",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Deny",
                "priority": 4001,
                "direction": "Inbound"
              }
            }
          ],
          "outputs": {}
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2017-05-10",
      "resourceGroup": "[parameters('VirtualNetworkResourceGroupName')]",
      "name": "ApplicationGateway-SecurityRules",
      "condition": "[equals(parameters('DeploymentType'),'ApplicationGateway')]",
      "dependsOn": [],
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
          "contentVersion": "2018.11.01.0",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_LOCAL_SUBNET_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows intra-subnet communication",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "sourceAddressPrefix": "[parameters('SubnetPrefix')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 110,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_AZURE_LB_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows inbound traffic from Azure Load Balancer",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "sourceAddressPrefix": "AzureLoadBalancer",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 111,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RACK_BASTION_RDP_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows RDP inbound from local RBAST subnet",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "[parameters('BastionPrefix')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 112,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RACK_BASTION_SSH_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows SSH inbound from local RBAST subnet",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "22",
                "sourceAddressPrefix": "[parameters('BastionPrefix')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 113,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RACK_BASTION_WinRM_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows WinRM inbound from local RACK_BASTION subnet",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "5986",
                "sourceAddressPrefix": "[parameters('BastionPrefix')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 114,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_RACK_BASTION_SFTBROKER_INBOUND')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows ScaleFT Broker agent inbound from local RACK_BASTION subnet",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "4421",
                "sourceAddressPrefix": "[parameters('BastionPrefix')]",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 115,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_Internet_Inbound_HTTP')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows inbound http to the Application Gateway subnet",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "80",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 133,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_Internet_Inbound_HTTPS')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allows inbound https to the Application Gateway subnet",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 134,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Allow_TCP_UDP_65200_65535')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Allow TCP and UDP 65200_65535",
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "65200-65535",
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "[parameters('SubnetPrefix')]",
                "access": "Allow",
                "priority": 135,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Deny_ALL_INBOUND_UDP')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Deny all inbound UDP",
                "protocol": "Udp",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Deny",
                "priority": 4000,
                "direction": "Inbound"
              }
            },
            {
              "apiVersion": "2016-03-30",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "name": "[concat(variables('name'),'/Deny_ALL_INBOUND_TCP')]",
              "location": "[resourceGroup().location]",
              "properties": {
                "description": "Deny all inbound TCP",
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Deny",
                "priority": 4001,
                "direction": "Inbound"
              }
            }
          ],
          "outputs": {}
        }
      }
    }
  ],
  "outputs": {
  }
}